@page "/pizza"
@rendermode InteractiveServer
@using Cafeteria.Shared.DTOs

<PageTitle>Pizza Station</PageTitle>

<div class="my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">
            <i class="bi bi-emoji-smile me-3"></i>Complete Your Meal
        </h1>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Pizza Station</h4>
        </div>

        <ul class="nav nav-tabs nav-fill border-bottom" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "entrees" ? "active" : "")"
                        type="button"
                        @onclick="@(() => SetActiveTab("entrees"))">
                    Pizza
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "toppings" ? "active" : "")"
                        type="button"
                        @onclick="@(() => SetActiveTab("toppings"))">
                    Toppings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "sides" ? "active" : "")"
                        type="button"
                        @onclick="@(() => SetActiveTab("sides"))">
                    Sides
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "drinks" ? "active" : "")"
                        type="button"
                        @onclick="@(() => SetActiveTab("drinks"))">
                    Drinks
                </button>
            </li>
        </ul>

        <div class="card-body p-0">
            <div class="p-3">
                @if (activeTab == "entrees")
                {
                    <div class="alert alert-warning mb-3" role="alert">
                        Select 1 pizza with your meal swipe
                    </div>

                    @foreach (var entree in Entrees)
                    {
                        <div class="card mb-2 @(selectedEntree?.Id == entree.Id ? "border-primary border-2" : "")"
                             style="cursor: pointer;"
                             @onclick="() => SelectEntree(entree)">
                            <div class="card-body d-flex justify-content-between align-items-center py-3">
                                <div>
                                    <strong>@entree.EntreeName</strong>
                                    @if (!string.IsNullOrEmpty(entree.EntreeDescription))
                                    {
                                        <div class="text-muted small">@entree.EntreeDescription</div>
                                    }
                                </div>
                                <div class="text-muted">
                                    $@entree.EntreePrice.ToString("F2")
                                </div>
                            </div>
                        </div>
                    }
                }
                else if (activeTab == "toppings")
                {
                    <div class="alert alert-warning mb-3" role="alert">
                        <strong>Please circle your choice of 2 Toppings</strong>
                        <div class="text-danger mt-1"><strong>NO SUBSTITUTIONS!!</strong></div>
                    </div>

                    <div class="alert alert-info mb-3" role="alert">
                        <strong>Choice of 2 Toppings</strong><br/>
                        <span class="text-muted">Additional toppings $0.50 each</span>
                    </div>

                    <div class="row">
                        @foreach (var topping in availableToppings)
                        {
                            <div class="col-md-6 mb-2">
                                <div class="card @(selectedToppings.Contains(topping) ? "border-primary border-2" : "")"
                                     style="cursor: pointer;"
                                     @onclick="() => ToggleTopping(topping)">
                                    <div class="card-body d-flex justify-content-between align-items-center py-2">
                                        <div>
                                            <strong>@topping</strong>
                                        </div>
                                        <div>
                                            @if (selectedToppings.Contains(topping))
                                            {
                                                <i class="bi bi-check-circle-fill text-primary fs-5"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-circle text-muted fs-5"></i>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    @if (selectedToppings.Count > 2)
                    {
                        <div class="alert alert-info mt-3" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            Additional charge: $@((selectedToppings.Count - 2) * 0.50m) for @(selectedToppings.Count - 2) extra topping(s)
                        </div>
                    }

                    @if (selectedToppings.Count > 0)
                    {
                        <div class="mt-3">
                            <strong>Selected Toppings (@selectedToppings.Count):</strong>
                            <div class="mt-2">
                                @foreach (var topping in selectedToppings)
                                {
                                    <span class="badge bg-primary me-2 mb-2 p-2">
                                        @topping
                                        <i class="bi bi-x-circle ms-1" style="cursor: pointer;" @onclick="() => ToggleTopping(topping)"></i>
                                    </span>
                                }
                            </div>
                        </div>
                    }
                }
                else if (activeTab == "sides")
                {
                    <div class="alert alert-warning mb-3" role="alert">
                        Select 1 side with your meal swipe
                    </div>

                    @foreach (var side in Sides)
                    {
                        <div class="card mb-2 @(selectedSide?.Id == side.Id ? "border-primary border-2" : "")"
                             style="cursor: pointer;"
                             @onclick="() => SelectSide(side)">
                            <div class="card-body d-flex justify-content-between align-items-center py-3">
                                <div>
                                    <strong>@side.SideName</strong>
                                    @if (!string.IsNullOrEmpty(side.SideDescription))
                                    {
                                        <div class="text-muted small">@side.SideDescription</div>
                                    }
                                </div>
                                <div>
                                    <span class="text-primary fw-bold">$@side.SidePrice.ToString("F2")</span>
                                </div>
                            </div>
                        </div>
                    }
                }
                else if (activeTab == "drinks")
                {
                    <div class="alert alert-info mb-3" role="alert">
                        <i class="bi bi-info-circle me-2"></i>Select 1 drink included with your meal swipe
                    </div>

                    @if (Drinks.Any())
                    {
                        @foreach (var drink in Drinks)
                        {
                            <div class="card mb-2 @(selectedDrink?.Id == drink.Id ? "border-success border-2" : "")"
                                 style="cursor: pointer;"
                                 @onclick="() => SelectDrink(drink)">
                                <div class="card-body d-flex justify-content-between align-items-center py-3">
                                    <div>
                                        <strong>@drink.DrinkName</strong>
                                        @if (!string.IsNullOrEmpty(drink.DrinkDescription))
                                        {
                                            <small class="text-muted d-block">@drink.DrinkDescription</small>
                                        }
                                    </div>
                                    <div>
                                        @if (selectedDrink?.Id == drink.Id)
                                        {
                                            <i class="bi bi-check-circle-fill text-success fs-4"></i>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                }
            </div>
        </div>

        <div class="card-footer bg-light">
            <div class="d-flex justify-content-between align-items-center w-100">
                <div>
                    <span class="text-muted">@GetSelectionCount() items selected</span>
                    @if (selectedToppings.Count > 0)
                    {
                        <span class="text-muted ms-2">| @selectedToppings.Count topping(s)</span>
                    }
                </div>
                <button type="button"
                        class="btn btn-primary btn-lg"
                        disabled="@(!IsValidSelection())"
                        @onclick="AddToOrder">
                    Add to Order
                </button>
            </div>
        </div>
    </div>

    @if (orderConfirmation != null)
    {
        <div class="alert alert-success alert-dismissible fade show mt-4" role="alert">
            <h5 class="alert-heading">
                <i class="bi bi-check-circle-fill me-2"></i>Order Added!
            </h5>
            <hr>
            <p class="mb-0"><strong>@orderConfirmation</strong></p>
            <button type="button" class="btn-close" @onclick="() => orderConfirmation = null"></button>
        </div>
    }
</div>

@code {
    private List<EntreeDto> Entrees = new List<EntreeDto>
    {
        new EntreeDto { Id = 1, StationId = 2, EntreeName = "Personal Pizza", EntreeDescription = "Choose 2 toppings included", EntreePrice = 5.69m }
    };

    private List<SideDto> Sides = new List<SideDto>
    {
        new SideDto { Id = 1, StationId = 2, SideName = "Chips", SideDescription = "Included with your meal", SidePrice = 0.00m }
    };

    private List<DrinkDto> Drinks = new List<DrinkDto>
    {
        new DrinkDto { Id = 1, StationId = 2, DrinkName = "Fountain Drinks", DrinkDescription = "Included with your meal", DrinkPrice = 0.00m },
        new DrinkDto { Id = 2, StationId = 2, DrinkName = "Slushies", DrinkDescription = "Included with your meal", DrinkPrice = 0.00m },
        new DrinkDto { Id = 3, StationId = 2, DrinkName = "Tea/Coffee Machines", DrinkDescription = "Included with your meal", DrinkPrice = 0.00m },
        new DrinkDto { Id = 4, StationId = 2, DrinkName = "Tea/Coffee Fridge", DrinkDescription = "Included with your meal", DrinkPrice = 0.00m },
        new DrinkDto { Id = 5, StationId = 2, DrinkName = "Drink Fridge", DrinkDescription = "Included with your meal", DrinkPrice = 0.00m }
    };

    private string activeTab = "entrees";
    private EntreeDto? selectedEntree = null;
    private SideDto? selectedSide = null;
    private DrinkDto? selectedDrink = null;
    private List<string> selectedToppings = new();
    private string? orderConfirmation = null;

    private List<string> availableToppings = new List<string>
    {
        "Extra Cheese",
        "Pepperoni",
        "Sausage",
        "Bacon",
        "Chicken",
        "Ham",
        "Olives",
        "Mushrooms",
        "Onions",
        "Pineapple",
        "Bell Peppers",
        "Banana Peppers"
    };

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private void SelectEntree(EntreeDto entree)
    {
        selectedEntree = entree;
    }

    private void SelectSide(SideDto side)
    {
        selectedSide = side;
    }

    private void SelectDrink(DrinkDto drink)
    {
        selectedDrink = drink;
    }

    private void ToggleTopping(string topping)
    {
        if (selectedToppings.Contains(topping))
        {
            selectedToppings.Remove(topping);
        }
        else
        {
            selectedToppings.Add(topping);
        }
    }

    private int GetSelectionCount()
    {
        int count = 0;
        if (selectedEntree != null) count++;
        if (selectedSide != null) count++;
        if (selectedDrink != null) count++;
        return count;
    }

    private bool IsValidSelection()
    {
        return selectedEntree != null && selectedSide != null && selectedDrink != null && selectedToppings.Count >= 2;
    }

    private void ClearSelections()
    {
        selectedEntree = null;
        selectedSide = null;
        selectedDrink = null;
        selectedToppings.Clear();
        activeTab = "entrees";
    }

    private void AddToOrder()
    {
        if (IsValidSelection() && selectedEntree != null && selectedSide != null && selectedDrink != null)
        {
            var meal = new MealDto
            {
                EntreeId = selectedEntree.Id,
                SideId = selectedSide.Id,
                DrinkId = selectedDrink.Id
            };

            var toppingsText = string.Join(", ", selectedToppings);
            orderConfirmation = $"Meal Plan/Swipe: {selectedEntree.EntreeName} with {toppingsText} and {selectedSide.SideName} and {selectedDrink.DrinkName}";

            Console.WriteLine($"Pizza Order: EntreeId={meal.EntreeId}, SideId={meal.SideId}, DrinkId={meal.DrinkId}");

            ClearSelections();
        }
    }
}

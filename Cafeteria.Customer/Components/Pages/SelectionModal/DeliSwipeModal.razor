@using Cafeteria.Shared.DTOs
@using Cafeteria.Customer.Components.Pages.SelectionModal

<GenericModal IsOpen="@IsOpen" 
              Title="Complete Your Meal - Deli Station" 
              OnClose="@Close"
              ModalSize="modal-xl"
              IsScrollable="true"
              HeaderClass="bg-primary text-white"
              BodyClass="p-0"
              FooterClass="bg-light"
              ShowCloseButton="true">
    <ChildContent>
        <ul class="nav nav-tabs nav-fill border-bottom" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "sandwich" ? "active" : "")" 
                        type="button" 
                        @onclick="@(() => SetActiveTab("sandwich"))">
                    Sandwich
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "sides" ? "active" : "")" 
                        type="button" 
                        @onclick="@(() => SetActiveTab("sides"))">
                    Sides
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "drinks" ? "active" : "")" 
                        type="button" 
                        @onclick="@(() => SetActiveTab("drinks"))">
                    Drinks
                </button>
            </li>
        </ul>
        <div class="p-3">
            @if (activeTab == "sandwich")
            {
                <div class="alert alert-danger mb-3" role="alert">
                    <strong>NO SUBSTITUTIONS!!</strong>
                </div>
                
                <div class="alert alert-info mb-3" role="alert">
                    <i class="bi bi-info-circle me-2"></i>~Comes with a Fountain Drink and 1 side~
                </div>

                <h5 class="mb-3">Bread (1):</h5>
                <div class="row row-cols-2 row-cols-md-3 g-2 mb-4">
                    @foreach (var bread in BreadOptions)
                    {
                        <div class="col">
                            <div class="card h-100 @(selectedBread == bread ? "border-primary border-2" : "")"
                                 style="cursor: pointer;"
                                 @onclick="() => selectedBread = bread">
                                <div class="card-body p-2 text-center">
                                    <small>@bread</small>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <h5 class="mb-3">Meat (1): <small class="text-muted">Additional Meats $0.75</small></h5>
                <div class="row row-cols-2 row-cols-md-3 g-2 mb-4">
                    @foreach (var meat in MeatOptions)
                    {
                        <div class="col">
                            <div class="card h-100 @(selectedMeat == meat ? "border-primary border-2" : "")"
                                 style="cursor: pointer;"
                                 @onclick="() => selectedMeat = meat">
                                <div class="card-body p-2 text-center">
                                    <small>@meat</small>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <h5 class="mb-3">Cheese (1):</h5>
                <div class="row row-cols-2 row-cols-md-3 g-2 mb-4">
                    @foreach (var cheese in CheeseOptions)
                    {
                        <div class="col">
                            <div class="card h-100 @(selectedCheese == cheese ? "border-primary border-2" : "")"
                                 style="cursor: pointer;"
                                 @onclick="() => selectedCheese = cheese">
                                <div class="card-body p-2 text-center">
                                    <small>@cheese</small>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <h5 class="mb-3">Toppings (3): <small class="text-muted">Additional toppings $0.50</small></h5>
                <div class="row row-cols-2 row-cols-md-3 g-2 mb-4">
                    @foreach (var topping in ToppingOptions)
                    {
                        <div class="col">
                            <div class="card h-100 @(selectedToppings.Contains(topping) ? "border-success border-2" : "")"
                                 style="cursor: pointer;"
                                 @onclick="() => ToggleTopping(topping)">
                                <div class="card-body p-2 text-center">
                                    <small>@topping</small>
                                    @if (selectedToppings.Contains(topping))
                                    {
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <h5 class="mb-3">Dressing (1):</h5>
                <div class="row row-cols-2 row-cols-md-3 g-2 mb-4">
                    @foreach (var dressing in DressingOptions)
                    {
                        <div class="col">
                            <div class="card h-100 @(selectedDressing == dressing ? "border-primary border-2" : "")"
                                 style="cursor: pointer;"
                                 @onclick="() => selectedDressing = dressing">
                                <div class="card-body p-2 text-center">
                                    <small>@dressing</small>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else if (activeTab == "sides")
            {
                <div class="alert alert-warning mb-3" role="alert">
                    Select 1 side with your meal swipe
                </div>
                
                @foreach (var side in Sides)
                {
                    <div class="card mb-2 @(selectedSide?.Id == side.Id ? "border-primary border-2" : "")" 
                         style="cursor: pointer;" 
                         @onclick="() => SelectSide(side)">
                        <div class="card-body d-flex justify-content-between align-items-center py-3">
                            <div>
                                <strong>@side.SideName</strong>
                                @if (!string.IsNullOrEmpty(side.SideDescription))
                                {
                                    <div class="text-muted small">@side.SideDescription</div>
                                }
                            </div>
                            <div>
                                <span class="text-primary fw-bold">$@side.SidePrice.ToString("F2")</span>
                            </div>
                        </div>
                    </div>
                }
            }
            else if (activeTab == "drinks")
            {
                <div class="alert alert-info mb-3" role="alert">
                    <i class="bi bi-info-circle me-2"></i>Select 1 drink included with your meal swipe
                </div>
                
                @if (Drinks.Any())
                {
                    @foreach (var drink in Drinks)
                    {
                        <div class="card mb-2 @(selectedDrink?.Id == drink.Id ? "border-success border-2" : "")"
                             style="cursor: pointer;"
                             @onclick="() => SelectDrink(drink)">
                            <div class="card-body d-flex justify-content-between align-items-center py-3">
                                <div>
                                    <strong>@drink.DrinkName</strong>
                                    @if (!string.IsNullOrEmpty(drink.DrinkDescription))
                                    {
                                        <small class="text-muted d-block">@drink.DrinkDescription</small>
                                    }
                                </div>
                                <div>
                                    @if (selectedDrink?.Id == drink.Id)
                                    {
                                        <i class="bi bi-check-circle-fill text-success fs-4"></i>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            }
        </div>
    </ChildContent>
    <FooterContent>
        <div class="d-flex justify-content-between align-items-center w-100">
            <div>
                <span class="text-muted">@GetSelectionCount() items selected</span>
            </div>
            <button type="button" 
                    class="btn btn-light btn-lg" 
                    disabled="@(!IsValidSelection())"
                    @onclick="AddToOrder">
                Add to Order
            </button>
        </div>
    </FooterContent>
</GenericModal>

@code {
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<MealDto> OnOrderSelected { get; set; }

    [Parameter]
    public List<SideDto> Sides { get; set; } = new();

    [Parameter]
    public List<DrinkDto> Drinks { get; set; } = new();

    private string activeTab = "sandwich";
    private string? selectedBread = null;
    private string? selectedMeat = null;
    private string? selectedCheese = null;
    private List<string> selectedToppings = new();
    private string? selectedDressing = null;
    private SideDto? selectedSide = null;
    private DrinkDto? selectedDrink = null;

    private List<string> BreadOptions = new()
    {
        "Marble Rye", "Sourdough", "Wheat", "White", "Gluten Free", "Salad (no bread)"
    };

    private List<string> MeatOptions = new()
    {
        "Ham", "Turkey", "Bacon", "Grilled Chicken", "Tuna Fish", "Chicken Salad"
    };

    private List<string> CheeseOptions = new()
    {
        "American", "Provolone", "Cheddar", "Pepper Jack", "Swiss", "Mozzarella"
    };

    private List<string> ToppingOptions = new()
    {
        "Spinach", "Romaine", "Green Leaf Lettuce", "Olives", "Cucumber", 
        "Tomato", "Sprouts", "Bell Pepper", "Onions", "Pickles", "Banana Peppers"
    };

    private List<string> DressingOptions = new()
    {
        "Oil", "Vinegar", "Ranch", "1000 Island", "Italian", "Caesar", 
        "Raspberry Vinaigrette", "Honey Mustard", "Mayonnaise", "Mustard"
    };

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private void SelectSide(SideDto side)
    {
        selectedSide = side;
    }

    private void SelectDrink(DrinkDto drink)
    {
        selectedDrink = drink;
    }

    private void ToggleTopping(string topping)
    {
        if (selectedToppings.Contains(topping))
        {
            selectedToppings.Remove(topping);
        }
        else
        {
            selectedToppings.Add(topping);
        }
    }

    private int GetSelectionCount()
    {
        int count = 0;
        if (selectedBread != null) count++;
        if (selectedMeat != null) count++;
        if (selectedCheese != null) count++;
        if (selectedToppings.Any()) count++;
        if (selectedDressing != null) count++;
        if (selectedSide != null) count++;
        if (selectedDrink != null) count++;
        return count;
    }

    private bool IsValidSelection()
    {
        return selectedBread != null 
            && selectedMeat != null 
            && selectedCheese != null 
            && selectedToppings.Any() 
            && selectedDressing != null
            && selectedSide != null 
            && selectedDrink != null;
    }

    private async Task Close()
    {
        IsOpen = false;
        ClearSelections();
        await OnClose.InvokeAsync();
    }

    private void ClearSelections()
    {
        selectedBread = null;
        selectedMeat = null;
        selectedCheese = null;
        selectedToppings.Clear();
        selectedDressing = null;
        selectedSide = null;
        selectedDrink = null;
        activeTab = "sandwich";
    }

    private async Task AddToOrder()
    {
        if (IsValidSelection() && selectedSide != null && selectedDrink != null)
        {
            // For Deli, we'll use a custom EntreeDto with description of the sandwich
            // In a real app, you'd have a proper Deli sandwich entree in the database
            var meal = new MealDto
            {
                EntreeId = 0, // This would be set properly with a Deli sandwich entree
                SideId = selectedSide.Id,
                DrinkId = selectedDrink.Id
            };

            await OnOrderSelected.InvokeAsync(meal);
            await Close();
        }
    }
}

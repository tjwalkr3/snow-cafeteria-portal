@page "/place-order"
@rendermode InteractiveServer
@using Cafeteria.Shared.DTOs
@using Cafeteria.Customer.Components.Pages

<PageTitle>Review Your Order</PageTitle>

<ConfirmationToast
    IsVisible="@_showToast"
    Title="Order Placed!"
    Message="@_toastMessage"
    OnHidden="@OnToastHidden" />

@if (!IsInitialized || _isLoading)
{
    <div class="loading-container">
        <Spinner Message="Loading your order..." />
    </div>
}
else if (IsInitialized && PlaceOrderVM.ErrorOccurred())
{
    Navigation.NavigateTo("/error", false);
}
else if (Order == null || (!Order.Entrees.Any() && !Order.Sides.Any() && !Order.Drinks.Any()))
{
    <div class="container px-3 py-4">
        <div class="empty-state">
            <h4>Error loading order</h4>
            <p>Your order is empty. Please build an order first.</p>
            <a href="@GetStationSelectUrl()" class="btn btn-primary">Start an Order</a>
        </div>
    </div>
}
else
{
    <div class="container px-3 py-4">
        <div class="mb-3">
            <a href="@GetStationSelectUrl()" class="btn text-decoration-none ps-0 back-button">
                ❮ Continue Shopping
            </a>
        </div>

        <div class="order-header">
            <h1 class="order-title">Your Order</h1>
            <p class="order-subtitle">Review your items before placing your order</p>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="items-summary">
                    <div class="items-count">
                        ITEMS <span>@GetTotalItemCount()</span>
                    </div>
                    <div class="est-time">
                        EST. MINUTES <span>15-20</span>
                    </div>
                </div>

                @* Entrees *@
                @foreach (var entreeItem in Order.Entrees)
        {
            <div class="order-item">
                <div class="item-header">
                    <div class="item-info">
                        <div class="item-name">@entreeItem.Entree.EntreeName</div>
                        <div class="item-description">
                            @if (entreeItem.SelectedOptions.Any())
                            {
                                @string.Join(", ", entreeItem.SelectedOptions.Select(o => o.Option.FoodOptionName))
                            }
                            else
                            {
                                <text>Our classic @entreeItem.Entree.EntreeName.ToLower()</text>
                            }
                        </div>
                    </div>
                    @if (Order.IsCardOrder)
                    {
                        <div class="item-price">$@GetItemPrice(entreeItem).ToString("F2")</div>
                    }
                </div>

                <div class="item-controls">
                    <div class="quantity-controls">
                        <button class="qty-btn" disabled>−</button>
                        <span class="qty-display">Qty: 1</span>
                        <button class="qty-btn" disabled>+</button>
                    </div>
                    <button class="remove-btn" disabled>Remove</button>
                </div>
            </div>
        }

        @* Sides *@
        @foreach (var sideItem in Order.Sides)
        {
            <div class="order-item">
                <div class="item-header">
                    <div class="item-info">
                        <div class="item-name">@sideItem.Side.SideName</div>
                        <div class="item-description">
                            @if (sideItem.SelectedOptions.Any())
                            {
                                @string.Join(", ", sideItem.SelectedOptions.Select(o => o.Option.FoodOptionName))
                            }
                            else
                            {
                                <text>Fresh @sideItem.Side.SideName.ToLower()</text>
                            }
                        </div>
                    </div>
                    @if (Order.IsCardOrder)
                    {
                        <div class="item-price">$@GetItemPrice(sideItem).ToString("F2")</div>
                    }
                </div>

                <div class="item-controls">
                    <div class="quantity-controls">
                        <button class="qty-btn" disabled>−</button>
                        <span class="qty-display">Qty: 1</span>
                        <button class="qty-btn" disabled>+</button>
                    </div>
                    <button class="remove-btn" disabled>Remove</button>
                </div>
            </div>
        }

        @* Drinks *@
        @foreach (var drink in Order.Drinks)
        {
            <div class="order-item">
                <div class="item-header">
                    <div class="item-info">
                        <div class="item-name">@drink.DrinkName</div>
                        <div class="item-description">Refreshing beverage</div>
                    </div>
                    @if (Order.IsCardOrder)
                    {
                        <div class="item-price">$@drink.DrinkPrice.ToString("F2")</div>
                    }
                </div>

                <div class="item-controls">
                    <div class="quantity-controls">
                        <button class="qty-btn" disabled>−</button>
                        <span class="qty-display">Qty: 1</span>
                        <button class="qty-btn" disabled>+</button>
                    </div>
                    <button class="remove-btn" disabled>Remove</button>
                </div>
            </div>
        }
            </div>

            <div class="col-lg-4">
                <div class="order-summary-card">
                    @if (Order.IsCardOrder)
                    {
                        <div class="summary-row">
                            <span class="summary-label">Subtotal:</span>
                            <span class="summary-value">$@Price.ToString("F2")</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Tax (7.75%):</span>
                            <span class="summary-value">$@((Price * 0.0775m).ToString("F2"))</span>
                        </div>
                        <hr class="summary-divider" />
                        <div class="total-row">
                            <span class="total-label">Total:</span>
                            <span class="total-value">$@((Price * 1.0775m).ToString("F2"))</span>
                        </div>
                    }
                    else
                    {
                        <div class="summary-row">
                            <span class="summary-label">Subtotal:</span>
                            <span class="summary-value">1 Swipe</span>
                        </div>
                        <hr class="summary-divider" />
                        <div class="total-row">
                            <span class="total-label">Total:</span>
                            <span class="total-value">1 Swipe</span>
                        </div>
                    }

                    <div class="action-buttons">
                        <button @onclick="HandlePlaceOrder" class="place-order-btn">Place Order</button>
                        <a href="@GetStationSelectUrl()" class="continue-shopping-btn">❮ Continue Shopping</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
